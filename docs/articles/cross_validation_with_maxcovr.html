<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Using Cross Validation with maxcovr &bull; maxcovr</title><!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"><script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous"><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">maxcovr</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../articles/index.html">Articles</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul><ul class="nav navbar-nav navbar-right"><li>
  <a href="https://github.com/njtierney/maxcovr">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Using Cross Validation with maxcovr</h1>
                        <h4 class="author">Nicholas Tierney</h4>
            
            <h4 class="date">2016-12-20</h4>
          </div>

    
    
<div class="contents">
<p>This vignette provides a guide to performing cross validation with modelr and maxcovr. In the future if this is a feature that is under demand, I will incorporate cross validation into maxcovr. In the mean time, here&rsquo;s a vignette.</p>
<div id="performing-cross-validation-on-max_coverage" class="section level1">
<h1 class="hasAnchor"><html><body><a href="#performing-cross-validation-on-max_coverage" class="anchor"> </a></body></html>performing cross validation on max_coverage</h1>
<p>We will stick with the previous example using york and york_crime</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(maxcovr)
<span class="kw">library</span>(tidyverse)

<span class="co"># subset to be the places with towers built on them.</span>
york_selected &lt;-<span class="st"> </span>york %&gt;%<span class="st"> </span><span class="kw">filter</span>(grade ==<span class="st"> "I"</span>)

york_unselected &lt;-<span class="st"> </span>york %&gt;%<span class="st"> </span><span class="kw">filter</span>(grade !=<span class="st"> "I"</span>)</code></pre></div>
<p>Thanks to the <code>modelr</code> package, it is relatively straightforward to perform cross validation.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># first we partition the data into 10 folds</span>
<span class="kw">library</span>(modelr)
mc_cv &lt;-<span class="st"> </span>modelr::<span class="kw">crossv_kfold</span>(york_crime, <span class="dv">10</span>) %&gt;%<span class="st"> </span>
<span class="st">    </span><span class="co"># we change the test and train sets from the `resample`</span>
<span class="st">    </span><span class="co"># to tibbles</span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">test =</span> <span class="kw">map</span>(test,as_tibble),
           <span class="dt">train =</span> <span class="kw">map</span>(train,as_tibble))</code></pre></div>
<p>This creates a dataframe with test and training sets</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mc_cv</code></pre></div>
<pre><code>## # A tibble: 10 &times; 3
##                    train                test   .id
##                   &lt;list&gt;              &lt;list&gt; &lt;chr&gt;
## 1  &lt;tibble [1,632 &times; 12]&gt; &lt;tibble [182 &times; 12]&gt;    01
## 2  &lt;tibble [1,632 &times; 12]&gt; &lt;tibble [182 &times; 12]&gt;    02
## 3  &lt;tibble [1,632 &times; 12]&gt; &lt;tibble [182 &times; 12]&gt;    03
## 4  &lt;tibble [1,632 &times; 12]&gt; &lt;tibble [182 &times; 12]&gt;    04
## 5  &lt;tibble [1,633 &times; 12]&gt; &lt;tibble [181 &times; 12]&gt;    05
## 6  &lt;tibble [1,633 &times; 12]&gt; &lt;tibble [181 &times; 12]&gt;    06
## 7  &lt;tibble [1,633 &times; 12]&gt; &lt;tibble [181 &times; 12]&gt;    07
## 8  &lt;tibble [1,633 &times; 12]&gt; &lt;tibble [181 &times; 12]&gt;    08
## 9  &lt;tibble [1,633 &times; 12]&gt; &lt;tibble [181 &times; 12]&gt;    09
## 10 &lt;tibble [1,633 &times; 12]&gt; &lt;tibble [181 &times; 12]&gt;    10</code></pre>
<p>We then fit the model on the training set using <code>map_df</code></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># then we fit the model</span>
<span class="kw">system.time</span>(
    mc_cv_fit &lt;-<span class="st"> </span><span class="kw">map_df</span>(mc_cv$train,
                     ~<span class="kw"><a href="../reference/max_coverage.html">max_coverage</a></span>(<span class="dt">existing_facility =</span> york_selected,
                                   <span class="dt">proposed_facility =</span> york_unselected,
                                   <span class="dt">user =</span> ., <span class="co"># training set goes here</span>
                                   <span class="dt">n_added =</span> <span class="dv">20</span>,
                                   <span class="dt">distance_cutoff =</span> <span class="dv">100</span>))
)</code></pre></div>
<pre><code>##    user  system elapsed 
##  12.913   1.320  14.593</code></pre>
<p>Then we can use the <code>summary_mc_cv</code> function to extract out the summaries from each fold. This summary takes the facilities placed using the training set of users, and then takes the test set of users and counts what percent of these are being covered by the training model.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">summarised_cv &lt;-<span class="st"> </span><span class="kw"><a href="../reference/summary_mc_cv.html">summary_mc_cv</a></span>(mc_cv_fit, mc_cv)

summarised_cv %&gt;%<span class="st"> </span>knitr::<span class="kw">kable</span>()</code></pre></div>
<table class="table"><thead><tr class="header"><th align="right">n_added</th>
<th align="left">n_fold</th>
<th align="right">distance_within</th>
<th align="right">n_cov</th>
<th align="right">pct_cov</th>
<th align="right">n_not_cov</th>
<th align="right">pct_not_cov</th>
<th align="right">dist_avg</th>
<th align="right">dist_sd</th>
</tr></thead><tbody><tr class="odd"><td align="right">20</td>
<td align="left">01</td>
<td align="right">100</td>
<td align="right">17</td>
<td align="right">0.0934066</td>
<td align="right">165</td>
<td align="right">0.9065934</td>
<td align="right">1061.507</td>
<td align="right">1152.357</td>
</tr><tr class="even"><td align="right">20</td>
<td align="left">02</td>
<td align="right">100</td>
<td align="right">17</td>
<td align="right">0.0934066</td>
<td align="right">165</td>
<td align="right">0.9065934</td>
<td align="right">1255.503</td>
<td align="right">1586.894</td>
</tr><tr class="odd"><td align="right">20</td>
<td align="left">03</td>
<td align="right">100</td>
<td align="right">20</td>
<td align="right">0.1098901</td>
<td align="right">162</td>
<td align="right">0.8901099</td>
<td align="right">1178.145</td>
<td align="right">1538.558</td>
</tr><tr class="even"><td align="right">20</td>
<td align="left">04</td>
<td align="right">100</td>
<td align="right">22</td>
<td align="right">0.1208791</td>
<td align="right">160</td>
<td align="right">0.8791209</td>
<td align="right">1077.369</td>
<td align="right">1362.671</td>
</tr><tr class="odd"><td align="right">20</td>
<td align="left">05</td>
<td align="right">100</td>
<td align="right">18</td>
<td align="right">0.0994475</td>
<td align="right">163</td>
<td align="right">0.9005525</td>
<td align="right">1211.470</td>
<td align="right">1602.905</td>
</tr><tr class="even"><td align="right">20</td>
<td align="left">06</td>
<td align="right">100</td>
<td align="right">26</td>
<td align="right">0.1436464</td>
<td align="right">155</td>
<td align="right">0.8563536</td>
<td align="right">1199.314</td>
<td align="right">1605.301</td>
</tr><tr class="odd"><td align="right">20</td>
<td align="left">07</td>
<td align="right">100</td>
<td align="right">24</td>
<td align="right">0.1325967</td>
<td align="right">157</td>
<td align="right">0.8674033</td>
<td align="right">1209.587</td>
<td align="right">1608.879</td>
</tr><tr class="even"><td align="right">20</td>
<td align="left">08</td>
<td align="right">100</td>
<td align="right">17</td>
<td align="right">0.0939227</td>
<td align="right">164</td>
<td align="right">0.9060773</td>
<td align="right">1251.735</td>
<td align="right">1557.213</td>
</tr><tr class="odd"><td align="right">20</td>
<td align="left">09</td>
<td align="right">100</td>
<td align="right">24</td>
<td align="right">0.1325967</td>
<td align="right">157</td>
<td align="right">0.8674033</td>
<td align="right">1089.314</td>
<td align="right">1497.305</td>
</tr><tr class="even"><td align="right">20</td>
<td align="left">10</td>
<td align="right">100</td>
<td align="right">24</td>
<td align="right">0.1325967</td>
<td align="right">157</td>
<td align="right">0.8674033</td>
<td align="right">1332.180</td>
<td align="right">1605.903</td>
</tr></tbody></table><p>Eyeballing the values, it looks like the pct coverage stays around 10%, but we can plot it to get a better idea. We can overlay the coverage obtained using the full dataset to get an idea of how we are performing.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">summarised_cv %&gt;%
<span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> n_fold,
               <span class="dt">y =</span> pct_cov)) +<span class="st"> </span>
<span class="st">    </span><span class="kw">geom_point</span>() +
<span class="st">    </span><span class="kw">geom_line</span>(<span class="dt">group =</span> <span class="dv">1</span>) +<span class="st"> </span>
<span class="st">    </span><span class="kw">theme_minimal</span>()</code></pre></div>
<p><img src="cross_validation_with_maxcovr_files/figure-html/unnamed-chunk-5-1.png" width="672"></p>
<p>Here we see that the pct_coverage doesn&rsquo;t seem to change much across the folds.</p>
<p>Coming up next, we will explore how to perform cross validation as we increase the number of facilities added.</p>
<p>Ideally, there should be a way to do this using purrr, so we don&rsquo;t have to fic 5 separate models, but perhaps this will change when we enable n_added to take a vector of values.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># then we fit the model</span>
<span class="kw">system.time</span>(
    mc_cv_fit_n20 &lt;-<span class="st"> </span><span class="kw">map_df</span>(mc_cv$train,
                     ~<span class="kw"><a href="../reference/max_coverage.html">max_coverage</a></span>(<span class="dt">existing_facility =</span> york_selected,
                                   <span class="dt">proposed_facility =</span> york_unselected,
                                   <span class="dt">user =</span> ., <span class="co"># training set goes here</span>
                                   <span class="dt">n_added =</span> <span class="dv">20</span>,
                                   <span class="dt">distance_cutoff =</span> <span class="dv">100</span>))
)</code></pre></div>
<pre><code>##    user  system elapsed 
##  14.466   1.569  17.895</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">system.time</span>(
    mc_cv_fit_n40 &lt;-<span class="st"> </span><span class="kw">map_df</span>(mc_cv$train,
                     ~<span class="kw"><a href="../reference/max_coverage.html">max_coverage</a></span>(<span class="dt">existing_facility =</span> york_selected,
                                   <span class="dt">proposed_facility =</span> york_unselected,
                                   <span class="dt">user =</span> ., <span class="co"># training set goes here</span>
                                   <span class="dt">n_added =</span> <span class="dv">40</span>,
                                   <span class="dt">distance_cutoff =</span> <span class="dv">100</span>))
)</code></pre></div>
<pre><code>##    user  system elapsed 
##  12.689   1.177  14.202</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">system.time</span>(
    mc_cv_fit_n60 &lt;-<span class="st"> </span><span class="kw">map_df</span>(mc_cv$train,
                     ~<span class="kw"><a href="../reference/max_coverage.html">max_coverage</a></span>(<span class="dt">existing_facility =</span> york_selected,
                                   <span class="dt">proposed_facility =</span> york_unselected,
                                   <span class="dt">user =</span> ., <span class="co"># training set goes here</span>
                                   <span class="dt">n_added =</span> <span class="dv">60</span>,
                                   <span class="dt">distance_cutoff =</span> <span class="dv">100</span>))
)</code></pre></div>
<pre><code>##    user  system elapsed 
##  12.666   1.149  14.456</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">system.time</span>(
    mc_cv_fit_n80 &lt;-<span class="st"> </span><span class="kw">map_df</span>(mc_cv$train,
                     ~<span class="kw"><a href="../reference/max_coverage.html">max_coverage</a></span>(<span class="dt">existing_facility =</span> york_selected,
                                   <span class="dt">proposed_facility =</span> york_unselected,
                                   <span class="dt">user =</span> ., <span class="co"># training set goes here</span>
                                   <span class="dt">n_added =</span> <span class="dv">80</span>,
                                   <span class="dt">distance_cutoff =</span> <span class="dv">100</span>))
)</code></pre></div>
<pre><code>##    user  system elapsed 
##  12.780   1.124  14.438</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">system.time</span>(
    mc_cv_fit_n100 &lt;-<span class="st"> </span><span class="kw">map_df</span>(mc_cv$train,
                     ~<span class="kw"><a href="../reference/max_coverage.html">max_coverage</a></span>(<span class="dt">existing_facility =</span> york_selected,
                                   <span class="dt">proposed_facility =</span> york_unselected,
                                   <span class="dt">user =</span> ., <span class="co"># training set goes here</span>
                                   <span class="dt">n_added =</span> <span class="dv">100</span>,
                                   <span class="dt">distance_cutoff =</span> <span class="dv">100</span>))
)</code></pre></div>
<pre><code>##    user  system elapsed 
##  13.200   1.252  15.185</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">summarised_cv_n20 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/summary_mc_cv.html">summary_mc_cv</a></span>(mc_cv_fit_n20, mc_cv)
summarised_cv_n40 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/summary_mc_cv.html">summary_mc_cv</a></span>(mc_cv_fit_n40, mc_cv)
summarised_cv_n60 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/summary_mc_cv.html">summary_mc_cv</a></span>(mc_cv_fit_n60, mc_cv)
summarised_cv_n80 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/summary_mc_cv.html">summary_mc_cv</a></span>(mc_cv_fit_n80, mc_cv)
summarised_cv_n100 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/summary_mc_cv.html">summary_mc_cv</a></span>(mc_cv_fit_n100, mc_cv)

bound_testing_summaries &lt;-<span class="st"> </span><span class="kw">bind_rows</span>(summarised_cv_n20,
                                     summarised_cv_n40,
                                     summarised_cv_n60,
                                     summarised_cv_n80,
                                     summarised_cv_n100) %&gt;%
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">type =</span> <span class="st">"test"</span>)</code></pre></div>
<p>It looks like the more facilities we add, the better the coverage&hellip;mostly.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">bound_training_summaries &lt;-<span class="st"> </span><span class="kw">bind_rows</span>(mc_cv_fit_n20$model_coverage,
                                      mc_cv_fit_n40$model_coverage,
                                      mc_cv_fit_n60$model_coverage,
                                      mc_cv_fit_n80$model_coverage,
                                      mc_cv_fit_n100$model_coverage) %&gt;%
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">type =</span> <span class="st">"training"</span>)

bound_all_summaries &lt;-<span class="st"> </span><span class="kw">bind_rows</span>(bound_testing_summaries,
                                 bound_training_summaries)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(bound_testing_summaries,
       <span class="kw">aes</span>(<span class="dt">x =</span> n_fold,
               <span class="dt">y =</span> pct_cov,
               <span class="dt">colour =</span> <span class="kw">factor</span>(n_added),
               <span class="dt">group =</span> <span class="kw">factor</span>(n_added))) +<span class="st"> </span>
<span class="st">    </span><span class="kw">geom_point</span>() +<span class="st"> </span>
<span class="st">    </span><span class="kw">geom_line</span>() +<span class="st"> </span>
<span class="st">    </span><span class="kw">theme_minimal</span>()</code></pre></div>
<p><img src="cross_validation_with_maxcovr_files/figure-html/unnamed-chunk-9-1.png" width="672"></p>
<p>Let&rsquo;s look at this another way, with boxplots for the number of facilities added.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(bound_testing_summaries,
       <span class="kw">aes</span>(<span class="dt">x =</span> <span class="kw">factor</span>(n_added),
           <span class="dt">y =</span> n_cov)) +
<span class="st">    </span><span class="kw">geom_boxplot</span>() +<span class="st"> </span>
<span class="st">    </span><span class="kw">theme_minimal</span>()</code></pre></div>
<p><img src="cross_validation_with_maxcovr_files/figure-html/unnamed-chunk-10-1.png" width="672"></p>
<p>We can also compare the % coverage for the test and training datasets</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">bound_all_summaries %&gt;%
<span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> <span class="kw">factor</span>(n_added),
               <span class="dt">y =</span> pct_cov,
               <span class="dt">fill =</span> type)) +<span class="st"> </span>
<span class="st">    </span><span class="kw">geom_boxplot</span>() +<span class="st"> </span>
<span class="st">    </span><span class="kw">theme_minimal</span>()</code></pre></div>
<p><img src="cross_validation_with_maxcovr_files/figure-html/unnamed-chunk-11-1.png" width="672"></p>
<!-- Vignettes are long form documentation commonly included in packages. Because they are part of the distribution of the package, they need to be as compact as possible. The `html_vignette` output type provides a custom style sheet (and tweaks some options) to ensure that the resulting html is as small as possible. The `html_vignette` format: -->
<!-- - Never uses retina figures -->
<!-- - Has a smaller default figure size -->
<!-- - Uses a custom CSS stylesheet instead of the default Twitter Bootstrap style -->
<!-- ## Vignette Info -->
<!-- Note the various macros within the `vignette` section of the metadata block above. These are required in order to instruct R how to build the vignette. Note that you should change the `title` field and the `\VignetteIndexEntry` to match the title of your vignette. -->
<!-- ## Styles -->
<!-- The `html_vignette` template includes a basic CSS theme. To override this theme you can specify your own CSS in the document metadata as follows: -->
<!--     output:  -->
<!--       rmarkdown::html_vignette: -->
<!--         css: mystyles.css -->
<!-- ## Figures -->
<!-- The figure sizes have been customised so that you can easily put two images side-by-side.  -->
<!-- ```{r, fig.show='hold'} -->
<!-- plot(1:10) -->
<!-- plot(10:1) -->
<!-- ``` -->
<!-- You can enable figure captions by `fig_caption: yes` in YAML: -->
<!--     output: -->
<!--       rmarkdown::html_vignette: -->
<!--         fig_caption: yes -->
<!-- Then you can use the chunk option `fig.cap = "Your figure caption."` in **knitr**. -->
<!-- ## More Examples -->
<!-- You can write math expressions, e.g. $Y = X\beta + \epsilon$, footnotes^[A footnote here.], and tables, e.g. using `knitr::kable()`. -->
<!-- ```{r, echo=FALSE, results='asis'} -->
<!-- knitr::kable(head(mtcars, 10)) -->
<!-- ``` -->
<!-- Also a quote using `>`: -->
<!-- > "He who gives up [code] safety for [code] speed deserves neither." -->
<!-- ([via](https://twitter.com/hadleywickham/status/504368538874703872)) -->
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2>Contents</h2>
      <ul class="nav nav-pills nav-stacked"><li><a href="#performing-cross-validation-on-max_coverage">performing cross validation on max_coverage</a></li>
      </ul></div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Nicholas Tierney.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer></div>

  </body></html>
